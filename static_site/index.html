<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Analysis & Strategy Recommender</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/plotly.js@2.24.1/dist/plotly.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .header {
            padding: 20px;
            margin-bottom: 20px;
            background-color: #0d6efd;
            color: white;
            border-radius: 5px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .options-table {
            font-size: 0.85rem;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .badge-bullish {
            background-color: #28a745;
        }
        .badge-bearish {
            background-color: #dc3545;
        }
        .badge-neutral {
            background-color: #6c757d;
        }
        .badge-volatile {
            background-color: #fd7e14;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1>Options Analysis & Strategy Recommender</h1>
            <p class="lead">Advanced options analysis with machine learning insights</p>
        </div>

        <div class="alert alert-warning">
            <h4>⚠️ DEMO MODE</h4>
            <p>This version uses simulated stock data to demonstrate functionality.</p>
            <p>All data shown is for demonstration purposes only and should not be used for actual trading decisions.</p>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">Stock Selection</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="ticker-input" class="form-label">Enter Stock Ticker:</label>
                            <input type="text" class="form-control" id="ticker-input" placeholder="e.g., AAPL" value="AAPL">
                        </div>
                        <div class="mb-3">
                            <label for="period-select" class="form-label">Historical Data Period:</label>
                            <select class="form-select" id="period-select">
                                <option value="1mo">1 Month</option>
                                <option value="3mo">3 Months</option>
                                <option value="6mo" selected>6 Months</option>
                                <option value="1y">1 Year</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="risk-select" class="form-label">Risk Tolerance:</label>
                            <select class="form-select" id="risk-select">
                                <option value="Conservative">Conservative</option>
                                <option value="Moderate" selected>Moderate</option>
                                <option value="Aggressive">Aggressive</option>
                            </select>
                        </div>
                        <button id="analyze-btn" class="btn btn-primary w-100">Analyze</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">Stock Information</div>
                    <div class="card-body">
                        <div id="stock-loading" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="stock-content" style="display: none;">
                            <div class="row">
                                <div class="col-md-8">
                                    <div id="price-chart" style="height: 400px;"></div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 id="company-name">Company Name</h4>
                                            <h2 id="current-price">$0.00</h2>
                                            <p id="price-change"><span class="badge bg-success">+0.00%</span></p>
                                            <div class="mb-2">
                                                <strong>Sector:</strong> <span id="sector">Technology</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Industry:</strong> <span id="industry">Software</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Market Cap:</strong> <span id="market-cap">$0B</span>
                                            </div>
                                            <hr>
                                            <h5>Market Outlook</h5>
                                            <h3><span id="outlook-badge" class="badge badge-neutral">Neutral</span></h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">Options Analysis</div>
                    <div class="card-body">
                        <div id="options-loading" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="options-content" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="expiry-select" class="form-label">Select Expiration Date:</label>
                                    <select class="form-select" id="expiry-select"></select>
                                </div>
                                <div class="col-md-6">
                                    <label for="option-type" class="form-label">Option Type:</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="option-type" id="calls-radio" value="calls" checked>
                                        <label class="btn btn-outline-primary" for="calls-radio">Calls</label>
                                        <input type="radio" class="btn-check" name="option-type" id="puts-radio" value="puts">
                                        <label class="btn btn-outline-primary" for="puts-radio">Puts</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped table-hover options-table">
                                    <thead>
                                        <tr>
                                            <th>Strike</th>
                                            <th>Price</th>
                                            <th>Bid</th>
                                            <th>Ask</th>
                                            <th>Volume</th>
                                            <th>Open Int</th>
                                            <th>IV</th>
                                            <th>ITM</th>
                                            <th>Win Prob.</th>
                                            <th>Exp. Return</th>
                                        </tr>
                                    </thead>
                                    <tbody id="options-table-body">
                                        <!-- Options data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">Option Analysis</div>
                                        <div class="card-body">
                                            <h5 id="selected-option-title">Strike Price Analysis</h5>
                                            <div id="option-details">
                                                <p><strong>Last Price:</strong> <span id="option-price">$0.00</span></p>
                                                <p><strong>Implied Volatility:</strong> <span id="option-iv">0.00%</span></p>
                                                <p><strong>Win Probability:</strong> <span id="option-win-prob">0.00%</span></p>
                                                <p><strong>Expected Return:</strong> <span id="option-exp-return">0.00%</span></p>
                                                <div id="option-greeks">
                                                    <p><strong>Greeks:</strong> Delta: 0.00 | Gamma: 0.00 | Theta: 0.00 | Vega: 0.00</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">Strategy Recommendation</div>
                                        <div class="card-body">
                                            <h5 id="strategy-name">Recommended Strategy</h5>
                                            <p id="strategy-description">Strategy description will appear here.</p>
                                            <div id="strategy-chart" style="height: 200px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">Volatility Analysis</div>
                    <div class="card-body">
                        <div id="volatility-loading" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="volatility-content" style="display: none;">
                            <div id="volatility-chart" style="height: 300px;"></div>
                            <p class="text-muted mt-2">Implied volatility from options pricing vs historical volatility from price movements.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-4 mb-4 text-center text-muted">
            <p>Demo version for Vercel deployment. Not financial advice.</p>
            <p>All data shown is simulated for demonstration purposes only.</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const analyzeBtn = document.getElementById('analyze-btn');
            
            // Initial load
            analyzeStock('AAPL', '6mo', 'Moderate');
            
            // Button click handler
            analyzeBtn.addEventListener('click', function() {
                const ticker = document.getElementById('ticker-input').value.toUpperCase();
                const period = document.getElementById('period-select').value;
                const risk = document.getElementById('risk-select').value;
                
                analyzeStock(ticker, period, risk);
            });
            
            // Option type change handler
            document.querySelectorAll('input[name="option-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const ticker = document.getElementById('ticker-input').value;
                    updateOptionsTable(window.currentOptionsData, this.value);
                });
            });
            
            // Expiry date change handler
            document.getElementById('expiry-select').addEventListener('change', function() {
                updateOptionsTable(window.currentOptionsData, getSelectedOptionType());
            });
        });
        
        function getSelectedOptionType() {
            return document.querySelector('input[name="option-type"]:checked').value;
        }
        
        async function analyzeStock(ticker, period, risk) {
            // Show loading states
            document.getElementById('stock-content').style.display = 'none';
            document.getElementById('stock-loading').style.display = 'flex';
            document.getElementById('options-content').style.display = 'none';
            document.getElementById('options-loading').style.display = 'flex';
            document.getElementById('volatility-content').style.display = 'none';
            document.getElementById('volatility-loading').style.display = 'flex';
            
            try {
                // Fetch price history
                const priceResponse = await fetch(`/api/price/${ticker}?period=${period}`);
                const priceData = await priceResponse.json();
                
                // Fetch options data
                const optionsResponse = await fetch(`/api/options/${ticker}`);
                const optionsData = await optionsResponse.json();
                
                // Fetch fundamentals
                const fundamentalsResponse = await fetch(`/api/fundamentals/${ticker}`);
                const fundamentals = await fundamentalsResponse.json();
                
                // Store data globally for other functions
                window.currentPriceData = priceData;
                window.currentOptionsData = optionsData;
                window.currentFundamentals = fundamentals;
                window.currentRisk = risk;
                
                // Update UI
                updateStockInfo(priceData, fundamentals);
                updateOptionsData(optionsData);
                updateVolatilityChart(priceData);
                
                // Hide loading states
                document.getElementById('stock-loading').style.display = 'none';
                document.getElementById('stock-content').style.display = 'block';
                document.getElementById('options-loading').style.display = 'none';
                document.getElementById('options-content').style.display = 'block';
                document.getElementById('volatility-loading').style.display = 'none';
                document.getElementById('volatility-content').style.display = 'block';
                
            } catch (error) {
                console.error('Error analyzing stock:', error);
                alert(`Error analyzing ${ticker}: ${error.message}`);
            }
        }
        
        function updateStockInfo(priceData, fundamentals) {
            // Basic company info
            document.getElementById('company-name').textContent = fundamentals.longName || fundamentals.shortName || fundamentals.symbol;
            document.getElementById('sector').textContent = fundamentals.sector || 'N/A';
            document.getElementById('industry').textContent = fundamentals.industry || 'N/A';
            document.getElementById('market-cap').textContent = formatMarketCap(fundamentals.marketCap);
            
            // Current price and change
            const latestPrice = priceData[priceData.length - 1].Close;
            const previousPrice = priceData[priceData.length - 2]?.Close || latestPrice;
            const priceChange = (latestPrice / previousPrice - 1) * 100;
            const priceChangeClass = priceChange >= 0 ? 'bg-success' : 'bg-danger';
            
            document.getElementById('current-price').textContent = `$${latestPrice.toFixed(2)}`;
            document.getElementById('price-change').innerHTML = `<span class="badge ${priceChangeClass}">${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%</span>`;
            
            // Market outlook
            // Simple algorithm to determine outlook based on recent price action and fundamentals
            let outlook = 'neutral';
            
            // Look at last 10 trading days
            const recentPrices = priceData.slice(-10);
            const firstPrice = recentPrices[0]?.Close;
            const lastPrice = recentPrices[recentPrices.length - 1]?.Close;
            const recentChange = firstPrice && lastPrice ? (lastPrice / firstPrice - 1) * 100 : 0;
            
            // Calculate volatility
            const volatility = calculateHistoricalVolatility(priceData.slice(-20));
            
            if (volatility > 0.25) {
                outlook = 'volatile';
            } else if (recentChange > 5) {
                outlook = 'bullish';
            } else if (recentChange < -5) {
                outlook = 'bearish';
            }
            
            // Update outlook badge
            const outlookBadge = document.getElementById('outlook-badge');
            outlookBadge.textContent = outlook.charAt(0).toUpperCase() + outlook.slice(1);
            outlookBadge.className = `badge badge-${outlook}`;
            
            // Create price chart
            createPriceChart(priceData, fundamentals.symbol);
        }
        
        function calculateHistoricalVolatility(prices) {
            if (!prices || prices.length < 2) return 0;
            
            // Calculate daily returns
            const returns = [];
            for (let i = 1; i < prices.length; i++) {
                returns.push(Math.log(prices[i].Close / prices[i-1].Close));
            }
            
            // Calculate standard deviation
            const mean = returns.reduce((sum, val) => sum + val, 0) / returns.length;
            const squaredDiffs = returns.map(val => Math.pow(val - mean, 2));
            const variance = squaredDiffs.reduce((sum, val) => sum + val, 0) / squaredDiffs.length;
            const stdDev = Math.sqrt(variance);
            
            // Annualize
            return stdDev * Math.sqrt(252);
        }
        
        function createPriceChart(priceData, ticker) {
            // Convert data for Plotly
            const dates = priceData.map(d => new Date(d.Date || d.date));
            const open = priceData.map(d => d.Open);
            const high = priceData.map(d => d.High);
            const low = priceData.map(d => d.Low);
            const close = priceData.map(d => d.Close);
            const volume = priceData.map(d => d.Volume);
            
            // Candlestick trace
            const candlesticks = {
                x: dates,
                open: open,
                high: high,
                low: low,
                close: close,
                type: 'candlestick',
                name: ticker,
                yaxis: 'y1'
            };
            
            // Volume bar chart
            const volumeBars = {
                x: dates,
                y: volume,
                type: 'bar',
                name: 'Volume',
                marker: {
                    color: volume.map((v, i) => close[i] >= open[i] ? 'rgba(0, 150, 136, 0.5)' : 'rgba(244, 67, 54, 0.5)')
                },
                yaxis: 'y2'
            };
            
            const layout = {
                title: `${ticker} Price History`,
                dragmode: 'zoom',
                showlegend: false,
                xaxis: { 
                    rangeslider: {
                        visible: false
                    },
                    type: 'date'
                },
                yaxis: {
                    title: 'Price',
                    domain: [0.3, 1],
                    tickformat: '.2f'
                },
                yaxis2: {
                    title: 'Volume',
                    domain: [0, 0.2],
                    tickformat: '.2s'
                },
                grid: {
                    rows: 2,
                    columns: 1,
                    pattern: 'independent'
                }
            };
            
            Plotly.newPlot('price-chart', [candlesticks, volumeBars], layout);
        }
        
        function updateOptionsData(optionsData) {
            // Check if options data is available
            if (!optionsData || !optionsData.expiry_dates || optionsData.expiry_dates.length === 0) {
                document.getElementById('options-content').innerHTML = 
                    '<div class="alert alert-info">No options data available for this ticker. Try popular tickers like AAPL, MSFT, AMZN, or SPY.</div>';
                return;
            }
            
            // Populate expiry dates dropdown
            const expirySelect = document.getElementById('expiry-select');
            expirySelect.innerHTML = '';
            
            optionsData.expiry_dates.forEach(date => {
                const formattedDate = new Date(date).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                const option = document.createElement('option');
                option.value = date;
                option.textContent = formattedDate;
                expirySelect.appendChild(option);
            });
            
            // Update options table with current selection
            updateOptionsTable(optionsData, getSelectedOptionType());
        }
        
        function updateOptionsTable(optionsData, optionType) {
            if (!optionsData || !optionsData.expiry_dates || optionsData.expiry_dates.length === 0) return;
            
            const expirySelect = document.getElementById('expiry-select');
            const selectedExpiry = expirySelect.value;
            const tableBody = document.getElementById('options-table-body');
            
            // Clear existing rows
            tableBody.innerHTML = '';
            
            // Get options data for selected expiry and type
            const options = optionsData.options[selectedExpiry]?.[optionType];
            
            if (!options || options.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="10" class="text-center">No ${optionType} options available for this expiration date.</td></tr>`;
                return;
            }
            
            // Sort by strike price
            const sortedOptions = [...options].sort((a, b) => a.strike - b.strike);
            
            // Add success probability and expected return for demo
            const currentPrice = window.currentPriceData[window.currentPriceData.length - 1].Close;
            sortedOptions.forEach(option => {
                // Calculate probability of success based on strike and current price
                const daysToExpiry = Math.round((new Date(selectedExpiry) - new Date()) / (1000 * 60 * 60 * 24));
                const volatility = option.impliedVolatility;
                
                if (optionType === 'calls') {
                    // For calls, success means price ends above strike
                    const moneyness = currentPrice / option.strike;
                    const stdDevs = Math.log(moneyness) / (volatility * Math.sqrt(daysToExpiry / 365));
                    option.win_probability = normalCDF(stdDevs);
                } else {
                    // For puts, success means price ends below strike
                    const moneyness = option.strike / currentPrice;
                    const stdDevs = Math.log(moneyness) / (volatility * Math.sqrt(daysToExpiry / 365));
                    option.win_probability = normalCDF(stdDevs);
                }
                
                // Expected return calculation
                const cost = option.lastPrice;
                const maxProfit = optionType === 'calls' ? Infinity : option.strike;
                const expectedReturn = (option.win_probability * maxProfit - cost) / cost;
                option.expected_return = expectedReturn;
            });
            
            // Add rows to table
            sortedOptions.forEach(option => {
                const row = document.createElement('tr');
                row.className = 'option-row';
                row.dataset.option = JSON.stringify(option);
                
                row.innerHTML = `
                    <td>${option.strike.toFixed(2)}</td>
                    <td>${option.lastPrice.toFixed(2)}</td>
                    <td>${option.bid.toFixed(2)}</td>
                    <td>${option.ask.toFixed(2)}</td>
                    <td>${option.volume.toLocaleString()}</td>
                    <td>${option.openInterest.toLocaleString()}</td>
                    <td>${(option.impliedVolatility * 100).toFixed(1)}%</td>
                    <td>${option.inTheMoney ? 'Yes' : 'No'}</td>
                    <td>${(option.win_probability * 100).toFixed(1)}%</td>
                    <td>${(option.expected_return * 100).toFixed(1)}%</td>
                `;
                
                // Highlight rows with high expected return
                if (option.expected_return > 0.2) {
                    row.className += ' table-success';
                } else if (option.expected_return < -0.1) {
                    row.className += ' table-danger';
                }
                
                tableBody.appendChild(row);
                
                // Add click handler
                row.addEventListener('click', function() {
                    document.querySelectorAll('.option-row').forEach(r => r.classList.remove('table-active'));
                    this.classList.add('table-active');
                    
                    const optionData = JSON.parse(this.dataset.option);
                    updateOptionDetails(optionData, optionType);
                });
            });
            
            // Select first row by default
            if (tableBody.firstChild) {
                tableBody.firstChild.click();
            }
        }
        
        function updateOptionDetails(option, optionType) {
            const currentPrice = window.currentPriceData[window.currentPriceData.length - 1].Close;
            
            // Update option details
            document.getElementById('selected-option-title').textContent = `$${option.strike.toFixed(2)} ${optionType === 'calls' ? 'Call' : 'Put'} Analysis`;
            document.getElementById('option-price').textContent = `$${option.lastPrice.toFixed(2)}`;
            document.getElementById('option-iv').textContent = `${(option.impliedVolatility * 100).toFixed(2)}%`;
            document.getElementById('option-win-prob').textContent = `${(option.win_probability * 100).toFixed(2)}%`;
            document.getElementById('option-exp-return').textContent = `${(option.expected_return * 100).toFixed(2)}%`;
            
            // Generate strategy recommendation
            generateStrategyRecommendation(option, optionType, currentPrice);
        }
        
        function generateStrategyRecommendation(option, optionType, currentPrice) {
            const outlook = document.getElementById('outlook-badge').textContent.toLowerCase();
            const risk = window.currentRisk;
            
            // Simple logic to recommend a strategy based on option, outlook, and risk
            let strategy = { name: '', description: '', payoff: [] };
            
            if (optionType === 'calls') {
                if (outlook === 'bullish') {
                    if (risk === 'Conservative') {
                        strategy.name = 'Covered Call';
                        strategy.description = 'Buy the stock and sell a call option to generate income. Limited upside but provides downside protection.';
                    } else if (risk === 'Moderate') {
                        strategy.name = 'Bull Call Spread';
                        strategy.description = 'Buy a call option and sell a higher strike call. Reduces cost and risk compared to a naked call, with capped profit potential.';
                    } else {
                        strategy.name = 'Long Call';
                        strategy.description = 'Buy a call option for maximum upside potential with defined risk. High leverage with possibility of total loss if price doesn\'t increase enough.';
                    }
                } else if (outlook === 'bearish') {
                    strategy.name = 'Bear Call Spread';
                    strategy.description = 'Sell a call option and buy a higher strike call. Generate income with limited risk if the market moves against you.';
                } else if (outlook === 'volatile') {
                    strategy.name = 'Long Straddle';
                    strategy.description = 'Buy both a call and put at the same strike price. Profits from significant price movement in either direction.';
                } else {
                    strategy.name = 'Iron Condor';
                    strategy.description = 'Sell a call spread and a put spread. Profits from price staying within a range, good for neutral markets with low volatility.';
                }
            } else { // puts
                if (outlook === 'bearish') {
                    if (risk === 'Conservative') {
                        strategy.name = 'Cash-Secured Put';
                        strategy.description = 'Sell a put option with cash set aside to buy shares if assigned. Generates income and potentially buys stock at a discount.';
                    } else if (risk === 'Moderate') {
                        strategy.name = 'Bear Put Spread';
                        strategy.description = 'Buy a put option and sell a lower strike put. Reduces cost and risk compared to a naked put, with capped profit potential.';
                    } else {
                        strategy.name = 'Long Put';
                        strategy.description = 'Buy a put option for downside protection or to profit from a price decline. Defined risk with significant leverage.';
                    }
                } else if (outlook === 'bullish') {
                    strategy.name = 'Bull Put Spread';
                    strategy.description = 'Sell a put option and buy a lower strike put. Generate income with limited risk if the market moves against you.';
                } else if (outlook === 'volatile') {
                    strategy.name = 'Long Strangle';
                    strategy.description = 'Buy an out-of-the-money call and put. Cheaper than a straddle, still profits from significant price movement in either direction.';
                } else {
                    strategy.name = 'Iron Butterfly';
                    strategy.description = 'Sell an at-the-money put and call, buy an out-of-the-money put and call. Maximum profit if price stays at the sold strikes.';
                }
            }
            
            // Update strategy card
            document.getElementById('strategy-name').textContent = strategy.name;
            document.getElementById('strategy-description').textContent = strategy.description;
            
            // Create payoff diagram
            createPayoffChart(strategy, option, optionType, currentPrice);
        }
        
        function createPayoffChart(strategy, option, optionType, currentPrice) {
            // Generate price points for x-axis (±30% around current price)
            const minPrice = currentPrice * 0.7;
            const maxPrice = currentPrice * 1.3;
            const pricePoints = [];
            const payoffs = [];
            
            for (let price = minPrice; price <= maxPrice; price += (maxPrice - minPrice) / 100) {
                pricePoints.push(price);
                
                // Calculate payoff based on strategy
                let payoff = 0;
                const strategyName = strategy.name.toLowerCase();
                
                if (strategyName === 'long call') {
                    payoff = Math.max(0, price - option.strike) - option.lastPrice;
                } else if (strategyName === 'long put') {
                    payoff = Math.max(0, option.strike - price) - option.lastPrice;
                } else if (strategyName === 'bull call spread') {
                    const upperStrike = option.strike * 1.1; // Simplified
                    payoff = Math.max(0, Math.min(price - option.strike, upperStrike - option.strike)) - option.lastPrice * 0.7;
                } else if (strategyName === 'bear put spread') {
                    const lowerStrike = option.strike * 0.9; // Simplified
                    payoff = Math.max(0, Math.min(option.strike - price, option.strike - lowerStrike)) - option.lastPrice * 0.7;
                } else if (strategyName === 'covered call') {
                    payoff = Math.min(option.strike - currentPrice, price - currentPrice) + option.lastPrice;
                } else if (strategyName === 'cash-secured put') {
                    payoff = Math.min(price - option.strike, option.lastPrice);
                } else if (strategyName.includes('strangle') || strategyName.includes('straddle')) {
                    // Simplified payoff
                    const callPayoff = Math.max(0, price - option.strike) - option.lastPrice;
                    const putPayoff = Math.max(0, option.strike - price) - option.lastPrice;
                    payoff = Math.max(callPayoff, putPayoff);
                } else {
                    // Generic payoff for iron condor, iron butterfly, etc.
                    payoff = price > option.strike * 0.95 && price < option.strike * 1.05 ? option.lastPrice * 0.5 : -option.lastPrice;
                }
                
                payoffs.push(payoff);
            }
            
            // Calculate breakeven price and mark it
            let breakevenPrice = optionType === 'calls' ? option.strike + option.lastPrice : option.strike - option.lastPrice;
            
            // Create plot
            const trace = {
                x: pricePoints,
                y: payoffs,
                type: 'scatter',
                mode: 'lines',
                line: {
                    color: 'blue',
                    width: 2
                },
                name: 'Payoff at Expiration'
            };
            
            const currentPriceVLine = {
                x: [currentPrice, currentPrice],
                y: [Math.min(...payoffs), Math.max(...payoffs)],
                type: 'scatter',
                mode: 'lines',
                line: {
                    color: 'green',
                    width: 2,
                    dash: 'dash'
                },
                name: 'Current Price'
            };
            
            const strikeVLine = {
                x: [option.strike, option.strike],
                y: [Math.min(...payoffs), Math.max(...payoffs)],
                type: 'scatter',
                mode: 'lines',
                line: {
                    color: 'red',
                    width: 2,
                    dash: 'dash'
                },
                name: 'Strike Price'
            };
            
            const layout = {
                title: 'Strategy Payoff at Expiration',
                xaxis: {
                    title: 'Stock Price',
                    tickformat: '$,.2f'
                },
                yaxis: {
                    title: 'Profit/Loss',
                    tickformat: '$,.2f'
                },
                shapes: [
                    {
                        type: 'line',
                        x0: minPrice,
                        y0: 0,
                        x1: maxPrice,
                        y1: 0,
                        line: {
                            color: 'black',
                            width: 1,
                            dash: 'dot'
                        }
                    }
                ],
                margin: {
                    l: 50,
                    r: 50,
                    b: 50,
                    t: 50,
                    pad: 4
                },
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1
                }
            };
            
            Plotly.newPlot('strategy-chart', [trace, currentPriceVLine, strikeVLine], layout);
        }
        
        function updateVolatilityChart(priceData) {
            // Calculate historical volatility
            const volData = [];
            const dates = [];
            
            // Use a 20-day window
            for (let i = 20; i < priceData.length; i++) {
                const windowData = priceData.slice(i-20, i);
                const volatility = calculateHistoricalVolatility(windowData) * 100; // as percentage
                volData.push(volatility);
                dates.push(new Date(priceData[i].Date || priceData[i].date));
            }
            
            // Create simulated implied volatility for demo
            const ivData = volData.map(hv => {
                // IV is typically higher than HV and mean-reverts
                const volPremium = Math.random() * 5 + 3; // 3-8% premium
                return hv + volPremium;
            });
            
            // Create chart
            const hvTrace = {
                x: dates,
                y: volData,
                type: 'scatter',
                mode: 'lines',
                name: 'Historical Volatility',
                line: {
                    color: 'blue',
                    width: 2
                }
            };
            
            const ivTrace = {
                x: dates,
                y: ivData,
                type: 'scatter',
                mode: 'lines',
                name: 'Implied Volatility',
                line: {
                    color: 'red',
                    width: 2
                }
            };
            
            const layout = {
                title: 'Volatility Comparison',
                xaxis: {
                    title: 'Date'
                },
                yaxis: {
                    title: 'Volatility (%)',
                    tickformat: '.1f'
                },
                margin: {
                    l: 50,
                    r: 50,
                    b: 50,
                    t: 50,
                    pad: 4
                }
            };
            
            Plotly.newPlot('volatility-chart', [hvTrace, ivTrace], layout);
        }
        
        // Helper functions
        function formatMarketCap(marketCap) {
            if (!marketCap) return 'N/A';
            
            if (marketCap >= 1e12) {
                return `$${(marketCap / 1e12).toFixed(2)}T`;
            } else if (marketCap >= 1e9) {
                return `$${(marketCap / 1e9).toFixed(2)}B`;
            } else if (marketCap >= 1e6) {
                return `$${(marketCap / 1e6).toFixed(2)}M`;
            } else {
                return `$${marketCap.toLocaleString()}`;
            }
        }
        
        // Standard normal cumulative distribution function
        function normalCDF(x) {
            const t = 1 / (1 + 0.2316419 * Math.abs(x));
            const d = 0.3989423 * Math.exp(-x * x / 2);
            let prob = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
            if (x > 0) {
                prob = 1 - prob;
            }
            return prob;
        }
    </script>
</body>
</html>